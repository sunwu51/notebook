---
title: next.jsæ•™ç¨‹
description: åŸºäºnext.js14çš„æ•™ç¨‹
date: 2024-06-15 15:00:00+8
tags:
    - next.js
    - æ•™ç¨‹
    - å‰ç«¯
    - ssr
---

# 1 å‰è¨€
æœ¬æ•™ç¨‹éœ€è¦ä½ æœ‰ä¸€å®šçš„å‰ç«¯åŸºç¡€ï¼Œå°¤å…¶æ˜¯`react`åŸºç¡€ï¼Œå¦åˆ™è¯·å…ˆå­¦ä¹ `react`ï¼›æœ¬æ•™ç¨‹åŸºæœ¬æ˜¯å¯¹å®˜æ–¹æ–‡æ¡£çš„å®è·µå’Œå†è§£è¯»ï¼Œä½¿å…¶é€šä¿—åŒ–ã€‚

æœ¬æ•™ç¨‹åŸºäºç›®å‰æœ€æ–°çš„`next.js` 14ç‰ˆæœ¬ï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£…`node.js`ï¼Œè¯·å…ˆå®‰è£…`node.js>18.17`å’Œ`npm`ï¼Œä¹‹å`next`æœ‰æ›´æ–°ï¼Œå¯èƒ½éƒ¨åˆ†å†…å®¹ä¸é€‚ç”¨ï¼Œè¯·æ³¨æ„diffã€‚

åˆ›å»º`next`é¡¹ç›®ï¼Œé€‰æ‹©å¦‚ä¸‹å‚æ•°ï¼Œä½¿ç”¨`js`å’Œ`src`ç›®å½•ï¼Œè¿™ä¸ªæ˜¯ä¸ªäººåå¥½ï¼Œå¦‚æœé€‰æ‹©äº†å…¶ä»–é€‰é¡¹ï¼Œè¯·è‡ªè¡Œæ³¨æ„diffã€‚
```bash
npx create-next-app
```

<AsciinemaPlayer src="https://asciinema.org/a/SApHPJwVLcheFQi5ckzx4Mh2F.cast" options = {{
        theme: 'tango',
        autoplay: true,
      }}/>

# 2 ç›®å½•æ–‡ä»¶ä¸è·¯ç”±
è¿™æ˜¯åˆ›å»ºå®Œæˆåçš„ç›®å½•ç»“æ„ï¼š

```
â””â”€â”€ ğŸ“my-app
    â””â”€â”€ .eslintrc.json
    â””â”€â”€ .gitignore
    â””â”€â”€ jsconfig.json
    â””â”€â”€ next.config.mjs
    â””â”€â”€ package-lock.json
    â””â”€â”€ package.json
    â””â”€â”€ postcss.config.mjs
    â””â”€â”€ ğŸ“public
        â””â”€â”€ next.svg
        â””â”€â”€ vercel.svg
    â””â”€â”€ README.md
    â””â”€â”€ ğŸ“src
        â””â”€â”€ ğŸ“app
            â””â”€â”€ favicon.ico
            â””â”€â”€ globals.css
            â””â”€â”€ layout.js
            â””â”€â”€ page.js
    â””â”€â”€ tailwind.config.js
```

æŒ¨ä¸ªè§£é‡Šä¸‹æ¯ä¸ªæ–‡ä»¶ç”¨é€”ï¼š
- `public`æ”¾ç½®é™æ€èµ„æºï¼Œä¾‹å¦‚å›¾ç‰‡ï¼Œå­—ä½“ç­‰ï¼Œé€šè¿‡`/next.svg`æ ¹è·¯å¾„è®¿é—®ã€‚
- `src`æ”¾ç½®æºç ï¼Œå…¶ä¸­çš„`app`ç›®å½•æœ€ä¸ºé‡è¦ï¼Œå› ä¸ºä½¿ç”¨`app router`ï¼Œæ‰€æœ‰çš„é¡µé¢éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹.
- `next.config.mjs`æ˜¯`next.js`çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®`webpack`ç­‰ã€‚
- `postcss.config.mjs`ä¸`tailwind.config.js`æ˜¯`tailwind`çš„é…ç½®æ–‡ä»¶ã€‚
- `package.json`æ˜¯`node.js`çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®`npm`åŒ…çš„ä¾èµ–ã€‚
- `jsconfig.json`æ˜¯jsçš„ä¸€äº›é…ç½®ï¼Œå½“å‰ä¸»è¦å†…å®¹æ˜¯é…ç½®äº†`@/*`ç­‰ä»·äº`./src/*`ã€‚

ç„¶åæˆ‘ä»¬è¦æŠŠ`app`ç›®å½•ä¸­çš„å†…å®¹å±•å¼€è¯´æ˜ä¸€ä¸‹ï¼Œå› ä¸ºé€‰æ‹©äº†`app router`ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ‰€æœ‰é¡µé¢éƒ½åº”è¯¥æŒ‰ç…§çº¦å®šæ”¾ç½®åˆ°appç›®å½•ä¸­ã€‚

## 2.1 page.jsçš„ä½œç”¨
`page.js`æ˜¯æœ€ç»ˆå‘ˆç°çš„é¡µé¢ä»£ç ï¼Œè·¯ç”±æ–¹å¼ä¸ºï¼š
- `/`ä¼šè·¯ç”±åˆ°`app/page.js`æ–‡ä»¶
- `/a`ä¼šè·¯ç”±åˆ°`app/a/page.js`æ–‡ä»¶

`page.js`ä¹Ÿå¯ä»¥æ”¹åä¸º`page.jsx`ç­‰åç¼€æ ¼å¼ï¼Œä¿®æ”¹å…¶å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢ä¼šå‘ç”Ÿå˜åŒ–ï¼Œ`export default`é»˜è®¤æš´éœ²å‡ºçš„reactç»„ä»¶ï¼Œä¼šä½œä¸ºé¡µé¢çš„å†…å®¹ï¼Œå¦‚ä¸‹ã€‚
```js :app/page.js
export default function Home() {
  return (
    <h1>Hello</h1>
  );
}
```
![image](https://i.imgur.com/VKsB8nm.png)

åˆ›å»º`app/a/page.js`æ–‡ä»¶ï¼Œå¹¶è®¿é—®`http://localhost:3000/a`

![image](https://i.imgur.com/Ezw3pYA.png)

## 2.2 layout.jsçš„ä½œç”¨
`layout.js`æ˜¯é¡µé¢çš„å¸ƒå±€æ–‡ä»¶ï¼Œä¸Šé¢çš„`page.js`çš„å†…å®¹ä¼šä½œä¸º`layout.js`ä¸­çš„`children`å±æ€§æ¸²æŸ“ã€‚

`layout.js`çš„ç”Ÿæ•ˆæ–¹å¼ä¸ºå åŠ ç”Ÿæ•ˆï¼š
- `app/layout.js`ä¼šå¯¹æ‰€æœ‰é¡µé¢ç”Ÿæ•ˆï¼ŒåŒ…æ‹¬`app/a/page.js`
- `app/a/layout.js`ä¼šå¯¹aè·¯å¾„åŠå…¶å­è·¯å¾„ç”Ÿæ•ˆï¼Œå³`app/a/page.js`ä¼šæœ‰ä¸¤å±‚`layout`ï¼Œå…ˆ`app/layout.js`ç„¶åæ˜¯`app/a/layout.js`ã€‚

åˆšæ‰çš„é¡µé¢æœ‰æ¡çº¹çŠ¶çš„æ ·å¼ï¼Œæ˜¯å› ä¸º`layout.js`å¼•å…¥äº†`globals.css`ï¼Œæˆ‘ä»¬ç®€åŒ–ä¸‹`layout.js`
```js :layout.js
export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
```

![image](https://i.imgur.com/tnp1vHK.png)

ç„¶ååˆ›å»º`app/a/layout.js`ä¿®æ”¹`/a`è·¯å¾„ä¸‹çš„`layout`ï¼Œä¼šå…ˆæ¸²æŸ“`app/a/layout.js`ï¼Œç„¶åå†æ¸²æŸ“`app/layout.js`ï¼Œæœ€åæŠŠ`app/a/page.js`ä½œä¸º`children`ã€‚

![image](https://i.imgur.com/hUlkdws.png)

![image](https://i.imgur.com/AwbPnr3.png)

## 2.3 not-found.jsä¸error.js
ä¸`layout.js`ç±»ä¼¼ï¼Œæ¯ä¸ªç›®å½•ä¸‹é¢éƒ½å¯ä»¥è®¾ç½®`not-found.js`ä¸`error.js`ã€‚åˆ†åˆ«ç”¨æ¥å¤„ç†è¯¥è·¯å¾„ä¸‹ï¼Œæ‰¾ä¸åˆ°é¡µé¢å’ŒæœåŠ¡ç«¯æŠ¥é”™çš„æƒ…å†µã€‚

åœ¨æ¼”ç¤ºä¹‹å‰æˆ‘ä»¬æŠŠ`globals.css`è¿›è¡Œç²¾ç®€ï¼Œå¹¶åœ¨`app/layout.js`ä¸­é‡æ–°å¼•å…¥ï¼Œä»¥ä¾¿ä½¿ç”¨`tailwind.css`æä¾›çš„ç®€æ´`className`ã€‚

```css :globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

```js :layout.js
import './globals.css';

......
```

æ·»åŠ `not-found.js`åˆ°`app`ç›®å½•ä¸‹ï¼Œå½“è®¿é—®ä¸å­˜åœ¨çš„é¡µé¢æ—¶å€™å°±ä¼šè¿”å›è¯¥é¡µé¢ã€‚

![notfound](https://i.imgur.com/4O6ghtE.png)

æ·»åŠ `error.js`åˆ°`app`ç›®å½•ä¸‹ï¼Œå½“æœåŠ¡ç«¯æŠ¥é”™çš„æ—¶å€™ä¼šè¿”å›è¯¥é¡µé¢ï¼Œæ³¨æ„`error.js`å¿…é¡»ç”¨`"use client"`å£°æ˜ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“çš„ç»„ä»¶ï¼Œåé¢æˆ‘ä»¬ä¼šä»‹ç»æ˜¯ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆã€‚

![error](https://i.imgur.com/9qPkNj2.png)

## 2.4 `[slug]`ä¸`[...slug]`åŠ¨æ€è·¯ç”±
ä¸Šé¢ä»‹ç»äº†`app`ç›®å½•ä¸‹æ¯ä¸ªç›®å½•éƒ½ä¼šæ„æˆè·¯ç”±ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå½•å…¥`/a`å¯¹åº”`app/a/page.js`ï¼Œè€Œ`/a/b/c`åˆ™å¯¹åº”`app/a/b/c/page.js`ï¼Œè¿™å°±æ˜¯é™æ€çš„è·¯ç”±ã€‚è€ŒåŠ¨æ€è·¯ç”±æ˜¯ï¼š
- `/b/xxx`å¯¹åº”`/b/[slug]/page.js`ï¼Œå…¶ä¸­`xxx`ä¼šä»¥`{"slug":"xxx"}`çš„å½¢å¼ä½œä¸º`params`å‚æ•°ï¼Œä¼ å…¥`page.js`
- åŒæ ·çš„å¤šçº§åŠ¨æ€è·¯ç”±åˆ™ä½¿ç”¨å¤šä¸ª`[path]`å³å¯ï¼Œä¾‹å¦‚`/c/[year]/[month]`

![image](https://i.imgur.com/DjkoX4l.png)

![image](https://i.imgur.com/Dqgfbef.png)

`[xx]`åªèƒ½åŒ¹é…è·¯å¾„ä¸­ä¸€ä¸ªçº§åˆ«ï¼Œå¦‚æœæƒ³è¦åŒ¹é…å¤šçº§ï¼Œåˆ™ä½¿ç”¨`[...xx]`

![image](https://i.imgur.com/DlC8mMW.png)

<iframe width="484" height="861" src="https://www.youtube.com/embed/Ml13-D4C8RU" title="Next.js 14 App Router in 1 minute" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerPolicy="strict-origin-when-cross-origin" allowFullScreen></iframe>

## 2.5 `_dir`ç§æœ‰ç›®å½•
`app/a`ä¼šè¢«æš´éœ²åˆ°`/a`è·¯å¾„ä¸‹ï¼Œè€Œ`_`å¼€å¤´çš„ç›®å½•åé»˜è®¤ä¸ä¼šè¢«åˆ›å»ºä¸ºè·¯å¾„ï¼Œä¾‹å¦‚`_dir/page.js`å¹¶ä¸èƒ½é€šè¿‡`/_dir`è®¿é—®åˆ°ï¼Œå¯ä»¥ç”¨æ¥æ”¾ç½®ä¸€äº›ä¸`UI`æ— å…³çš„ä»£ç ï¼Œæ¯”å¦‚ä¸€äº›serverç«¯çš„æ–‡ä»¶æ“ä½œç­‰ã€‚

![image](https://i.imgur.com/aCs0eYU.png)

å¦‚æœä¸€ä¸ªå·¥å…·ç±»`util.js`ï¼Œä½ å¯ä»¥æ”¾åˆ°`app/_utils`ç›®å½•ä¸‹ï¼Œæ¥è¡¨ç¤ºä»–æ˜¯`app`çš„ä¸€éƒ¨åˆ†ï¼Œä¸ä¼šåœ¨`app`ä¹‹å¤–è¢«ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥æ”¾åˆ°`src/utils`ç›®å½•ä¸‹ï¼Œä»–è¡¨ç¤ºå¯ä»¥åœ¨æ•´ä¸ªé¡¹ç›®çº§åˆ«è¢«è®¿é—®ã€‚
## 2.6 `(group)`åˆ†ç»„è·¯ç”±
ä¸­æ‹¬å·`[slug]`æ˜¯åŠ¨æ€è·¯ç”±ï¼Œè€Œå°æ‹¬å·è·¯å¾„`(group)`æ˜¯åˆ†ç»„è·¯ç”±ï¼Œåˆ†ç»„ç›®å½•ä¸å‚ä¸è·¯ç”±çš„è·¯å¾„ï¼Œåªæ˜¯æŠŠå¤šä¸ªç›®å½•æ”¾åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚ä¸€æ–¹é¢æ˜¯ç»“æ„æ›´æ¸…æ™°ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥åœ¨åˆ†ç»„çº§åˆ«åˆ›å»º`layout.js`å¯¹åˆ†ç»„å†…ç”Ÿæ•ˆã€‚

![image](https://i.imgur.com/MnLcc4v.png)

## 2.7 loading.jsä¸template.js
`loading.js`è¡¨ç¤ºé¡µé¢åŠ è½½æ—¶å€™æ ·å­ï¼Œä»–ä¼šåœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­æ›¿ä»£`page.js`çš„ä½ç½®ï¼Œç›´åˆ°åè€…åŠ è½½å®Œæˆï¼Œä¾‹å¦‚æœåŠ¡ç«¯éœ€è¦ä¸€äº›ioæ“ä½œï¼Œè·å–æ•°æ®ä¹‹åæ‰èƒ½æ¸²æŸ“ï¼Œæ­¤æ—¶å°±ä¼šè§¦å‘`loading`ï¼Œæ­¤å¤–`loading.js`å¯ä»¥ç›®å½•çº§åˆ«æŒ‡å®š/
![image](https://i.imgur.com/Y3BUuCr.gif)

`template.js`ä¸`layout.js`éå¸¸ç›¸ä¼¼ï¼Œå”¯ä¸€çš„ä¸åŒåœ¨äºï¼Œä½¿ç”¨`Link`è·³è½¬é¡µé¢çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å‰åé¡µé¢ä½¿ç”¨ç›¸åŒçš„`layout`ï¼Œåˆ™è¿™éƒ¨åˆ†ç»„ä»¶ä¸ä¼šå¸è½½ï¼Œåªä¼šæ›´æ–°å˜åŒ–çš„å†…å®¹ã€‚è€Œä½¿ç”¨`template`åˆ™ä¼šå¼ºåˆ¶å¸è½½å¹¶é‡æ–°è£…è½½ç»„ä»¶ã€‚

æˆ‘ä»¬åœ¨ä¸Šé¢`login`å’Œ`register`ï¼Œé¡µé¢ä¸‹æ–¹æ·»åŠ `<Link>`ä½¿å¾—ä¸¤ä¸ªé¡µé¢å¯ä»¥è·³è½¬ï¼š
```js :login.js
import Link from "next/link";

export default function Login() {
    return (
    <div>
        <h1>ç™»å½•</h1>
        <hr />
        <Link href="register" className="text-blue-300">
            åˆ‡æ¢åˆ°æ³¨å†Œé¡µ
        </Link>
    </div>)
}
```
```js :register.js
import Link from "next/link";

export default function Login() {
    return <div> 
        <h1>æ³¨å†Œ</h1>
        <hr />
        <Link href="login" className="text-blue-300">
            åˆ‡æ¢åˆ°ç™»å½•é¡µ
        </Link>
    </div>
}
```
ç„¶ååœ¨`(auth)`ç›®å½•ä¸‹æ·»åŠ `template.js`å¹¶ä¿®æ”¹`layout.js`
```js :template.js
export default function AuthLayout({children}) {
    return <div>
        <label>from template:
            <input className="text-black"/>
        </label>
        <div>{children}</div>
    </div>
}
```
```js :layout.js
export default function AuthLayout({children}) {
    return <div>
        <h1>
            Welcome to my website
        </h1>
        <label>from layout:
            <input className="text-black" />
        </label>
        <div>{children}</div>
    </div>
}
```

æ­¤æ—¶åˆ‡æ¢é¡µé¢ï¼Œå°±ä¼šå‘ç°ï¼Œ`layout`ä¸‹çš„`input`ç»„ä»¶æ²¡æœ‰å¸è½½ï¼Œä»ç„¶ä¿ç•™åŸæ¥çš„valueï¼Œè€Œ`template`ä¸­çš„ç»„ä»¶ä¼šè¢«å¸è½½ï¼Œé‡æ–°æ¸²æŸ“ã€‚

![image](https://i.imgur.com/BjCYi1V.gif)

å½“ç„¶è¿™æ˜¯nextä¸­çš„`Link`åˆ‡æ¢æ‰æœ‰çš„æ•ˆæœï¼Œå¦‚æœæ˜¯æ™®é€šçš„`a`æ ‡ç­¾ï¼Œæˆ–è€…ç›´æ¥åœ°å€æ é‡æ–°è¾“å…¥åœ°å€ï¼Œåˆ™éƒ½ä¼šå¸è½½ã€‚

## 2.8 `@parallel`å¹¶è¡Œè·¯ç”±
`@dir`ç›®å½•ä»£è¡¨çš„æ˜¯å¹¶è¡Œè·¯ç”±ï¼Œç”¨`slot`çš„æ¦‚å¿µæ›´ç¡®åˆ‡ä¸€äº›ã€‚å½“æˆ‘ä»¬åˆ›å»º`app/f/layout.js`é¡µé¢ï¼Œå¸Œæœ›é¡µé¢ä¸­æœ‰å¤šä¸ªæ§½ä½ï¼Œæ¯ä¸ªä½ç½®å±•ç¤ºä¸åŒçš„å†…å®¹ï¼Œå¹¶ä¸”éœ€è¦æ ¹æ®è·¯å¾„å˜åŒ–è€Œå˜åŒ–ã€‚
```js :app/f/layout.js
export default function Parallel({left, right, children}) {
    return <div className="flex">
        <div>{left}</div>
        <div>{right}</div>
    </div>
}
```
`layout.js`ä¸­çš„å‚æ•°`left`å’Œ`right`é€šè¿‡ï¼Œå½“å‰ç›®å½•ä¸‹çš„`@left/page.js`å’Œ`@right/page.js`ä¼ å…¥ï¼Œä¸éœ€è¦`import`è‡ªåŠ¨ä¼ å…¥ã€‚è€Œ`children`åˆ™æ˜¯å½“å‰ç›®å½•ä¸‹çš„`page.js`è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå¿½ç•¥`children`å˜é‡å³å¯ã€‚

åˆ°è¿™ä¸ºæ­¢ï¼Œæ•ˆæœä¸æˆ‘ä»¬ç›´æ¥åœ¨`layout.js`æˆ–è€…`page.js`ä¸­å»`import left right`æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯æ¯ä¸ªç›®å½•ä¸‹åˆå¯ä»¥æœ‰æ–°çš„ç›®å½•ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿå¤æ‚çš„è·¯ç”±æ­é…ã€‚

```
â””â”€â”€ ğŸ“f
    â””â”€â”€ ğŸ“@left
        â””â”€â”€ page.js
    â””â”€â”€ ğŸ“@right
        â””â”€â”€ ğŸ“item
            â””â”€â”€ page.js
        â””â”€â”€ page.js
    â””â”€â”€ layout.js
```
åœ¨`@right`ä¸‹é¢åˆ›å»º`item`ç›®å½•ï¼Œå¹¶åˆ›å»º`page.js`ï¼Œå¹¶ä¿®æ”¹`right.js`ï¼Œæ·»åŠ ä¸€ä¸ª`Link`æ ‡ç­¾ï¼Œæ­¤æ—¶è·³è½¬åˆ°`/f/item`ï¼Œå·¦è¾¹è¿˜æ˜¯`Left`ç»„ä»¶ï¼Œå³è¾¹ä»`Right`å˜æˆäº†`Item`ç»„ä»¶ã€‚
```js :right.js
import Link from "next/link";

export default function Right() {
    return <><h1>Right</h1>
        <Link href="./f/item">GoToItem</Link>
    </>
}
```
![image](https://i.imgur.com/OCVl7Ad.gif)

ä½†æ˜¯é€šè¿‡`url`ç›´æ¥è®¿é—®æ˜¯404ï¼Œè¿™æ˜¯å› ä¸ºç›´æ¥è®¿é—®çš„æ—¶å€™ï¼Œå·¦è¾¹çš„ç»„ä»¶ä¹Ÿéœ€è¦å¹¶è¡Œå»è·¯ç”±ï¼Œæ­¤æ—¶æ‰¾ä¸åˆ°`@left/item/page.js`ï¼Œå°±404äº†ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡`@left/default.js`æ¥é…ç½®å¹¶è¡Œè·¯ç”±çš„é»˜è®¤å€¼ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æŠŠ`@left/page.js`é‡å‘½åä¸º`@left/default.js`å³å¯ã€‚

## 2.9 `(.)path`æ‹¦æˆªè·¯ç”±
`(.)path`è¿™æ˜¯ä¸€ä¸ªç›®å½•çš„åå­—ï¼Œè¿™ä¸ª`(.)path/page.js`ä¼šæ‹¦æˆªï¼Œå½“å‰è·¯å¾„ä¸‹æƒ³è¦é€šè¿‡`Link`è·³è½¬åˆ°`./path`è¿™ä¸ªè·¯å¾„çš„è¯·æ±‚ã€‚

ä¾‹å¦‚åœ¨`app/g`ä¸‹åˆ›å»ºå¦‚ä¸‹è·¯å¾„
```
â””â”€â”€ ğŸ“g
    â””â”€â”€ ğŸ“g1
        â””â”€â”€ page.js
    â””â”€â”€ page.js
```
å…¶ä¸­gé…ç½®`Link`è·³è½¬`/g/g1`è€Œg1åˆ™è·³è½¬åˆ°`/g`ï¼Œå®ç°äº’ç›¸è·³è½¬ã€‚

![img](https://i.imgur.com/xp5Svox.gif)

æ­¤æ—¶ï¼Œåˆ›å»º`g/(.)g1/page.js`å®ç°æ‹¦æˆªï¼š
```js :g/(.)g1/page.js
import Link from "next/link";

export default function G1() {
    return <>
    <h1>è¢«æ‹¦æˆªåçš„g1</h1>
    <Link href="/g">Go To g</Link>
    </>
}
```
æ³¨æ„ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿä¸‹æ²¡æœ‰è¢«æ‹¦æˆªï¼Œå¯èƒ½æ˜¯`developer`æ¨¡å¼å¯¼è‡´çš„bugï¼Œå¯ä»¥å°è¯•`npm run build && npm run start`å†è¯•è¯•çœ‹ï¼Œè¿™ä¸ªbugå¯èƒ½åœ¨åç»­çš„ç‰ˆæœ¬ä¼šä¿®å¤ã€‚

![image](https://i.imgur.com/NrMJSaX.gif)


![image](https://cdn.builder.io/api/v1/image/assets%2FYJIGb4i01jvw0SRdL5Bt%2F37d97d0f7eea431fa9185676bd798645?format=webp&width=2000)

å¦‚æœæƒ³è¦æ‹¦æˆªä¸Šä¸€çº§åˆ™ä½¿ç”¨`(..)path`å¦‚æœæ˜¯ä¸Šé¢ä¸¤çº§å°±`(..)(..)path`ï¼Œå¦‚æœæ˜¯æ‹¦æˆªæ ¹è·¯å¾„ä¸‹çš„åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨`(...)path`ã€‚
## 2.10 `route.js`é…ç½®apiæ¥å£
ä¸`page.js`ç±»ä¼¼ï¼Œ`route.js`å¯ä»¥é…ç½®httpæ¥å£ï¼Œå…¶ä¸­æ–¹æ³•åå†³å®šäº†è¯·æ±‚çš„ç±»å‹ä¾‹å¦‚ä¸‹é¢`GET`æ–¹æ³•ä»£è¡¨å¯ä»¥å¤„ç†`GET`è¯·æ±‚ã€‚

æ³¨æ„ï¼šè¿™é‡Œçš„`GET`æ˜¯å›ºå®šçš„å†™æ³•ï¼Œ`export`çš„ä¸æ˜¯`default`è€Œæ˜¯`GET`è¿™ä¸ªå‡½æ•°ï¼Œåˆ›å»º`POST`å‡½æ•°åœ¨ç›¸åŒæ–‡ä»¶ä¸‹ï¼Œå°±å¯¹åº”`POST`è¯·æ±‚ï¼Œå…¶ä»–æ–¹æ³•ç±»ä¼¼çš„ã€‚

![image](https://i.imgur.com/zBSH1fY.png)

é¿å…åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼ŒåŒæ—¶å­˜åœ¨`page.js`å’Œ`route.js`ï¼Œä¼šå¯¼è‡´åªæœ‰åè€…ç”Ÿæ•ˆã€‚æ³¨æ„åœ¨`route.js`ä¸­å…¥å‚çš„requestï¼Œè¿”å›çš„responseéƒ½æ˜¯`Web Fetch API`æ ‡å‡†å®šä¹‰çš„ç±»å‹ï¼Œ[å‚è€ƒ](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)ï¼Œå¤§å¤šæ•°æ“ä½œéƒ½å¯ä»¥å‚è€ƒmdnï¼Œä¾‹å¦‚`cookie` `header`ç­‰ï¼Œä¸‹é¢åªåˆ—å‡ºéƒ¨åˆ†å¸¸è§çš„ã€‚

å‚æ•°ä¸è¿”å›å€¼è¯´æ˜ï¼š
```js
// POST /posts/1?query=hi {a:1}
// params = {id:1}
// query = hi
// jsonFromParam = {a:1}

// requestæ˜¯Requestç±»å‹, paramsæ˜¯å½“route.jsä½äº[slug]ä¸­è·å–è·¯å¾„å‚æ•°ç”¨çš„
export async function POST(request, {params}) {
    const searchParams = request.nextUrl.searchParams; 
    // æŸ¥è¯¢å­—ç¬¦ä¸²,nextUrlæ˜¯é¢å¤–æ³¨å…¥çš„ï¼Œéweb apiè‡ªå¸¦
    // ä¹Ÿå¯ä»¥ç”¨const { searchParams } = new URL(request.url);

    const query = searchParams.get("query")    // searchParams.queryä¹Ÿè¡Œ
    const jsonParam = await request.json();                 // è§£æjsonå‚æ•°
    const formParam = await request.formData();             // è§£æformå‚æ•°
    // è¿”å›jsonç»“æœ
    return Response.json({id:1, name: "frank"})
    // ç­‰ä»·äº
    // return new Response(JSON.stringify({id:1, name: "frank"}), {
    //         headers: {
    //             "Content-Type": "application/json"
    //         },
    //         status: 201,
    //     }
    // )
}
```
å¯¹äºè¿”å›å€¼å¯ä»¥æ˜¯WebAPIä¸­çš„`Response`å¦‚ä¸Šï¼Œä½†ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`NextResponse`æ˜¯ç»§æ‰¿è‡ª`Response`çš„ã€‚
```js
return NextResponse.redirect(new URL('/', request.url)) 
// é‡å®šå‘åˆ°å¦ä¸€ä¸ªé¡µé¢/æ¥å£

return NextResponse.rewrite(new URL('/', request.url)) 
// å†…å®¹æ˜¯å¦ä¸€ä¸ªé¡µé¢/æ¥å£ï¼Œä½†æ˜¯è·¯å¾„è¿˜æ˜¯å½“å‰çš„
```
ï¼ï¼æ³¨æ„ï¼šapiçš„å†…å®¹åœ¨prodæ¨¡å¼ä¸‹ï¼Œä¼šè¢«ç¼“å­˜å¾ˆä¹…ï¼Œè¦æƒ³ç¦ç”¨ç¼“å­˜ï¼Œå¯ä»¥åœ¨`route.js`ä¸­æ·»åŠ 
```js :route.js
export const dynamic = 'force-dynamic' // é»˜è®¤å€¼autoï¼Œä¼šå°½å¯èƒ½å ç”¨å†…å­˜æ¥ç¼“å­˜
```
## 2.11 `middleware.js`é…ç½®ä¸­é—´ä»¶
`/src/middleware.js`ä¼šæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œè¿›è¡Œæ³¨å…¥å¤„ç†ï¼Œæ³¨æ„ä¸­é—´ä»¶æ˜¯å…¨å±€çš„ï¼Œå¹¶ä¸”æ˜¯åœ¨`src`ç›®å½•ï¼Œå³å’Œ`app`ç›®å½•åŒçº§ä¸‹ã€‚
```js :middleware.js
export function middlreware(request) {
    // å¯¹requestè¿›è¡Œæ ¡éªŒï¼Œä¾‹å¦‚è·¯å¾„ï¼Œcookieï¼Œheaderç­‰ç­‰åˆ¤æ–­æƒé™
    if (url != login && æ²¡æœ‰ç™»é™†) {
        return NextResponse.redirect(new URL('/login'))
    } 
    return NextResponse.next(); // ä»£è¡¨é€šè¿‡ï¼Œç»§ç»­è®¿é—®è¯¥è·¯å¾„
}
```
## 2.11 ç›®å½•æ–‡ä»¶ä¸è·¯ç”±å°ç»“
æ–‡ä»¶åï¼š
- `layout.js`å¸ƒå±€é¡µï¼Œæ¯ä¸ªç›®å½•ä¸‹å¯ä»¥æœ‰ä¸€ä¸ª
- `template.js`æ¨¡æ¿é¡µï¼Œæ¯ä¸ªç›®å½•ä¸‹å¯ä»¥æœ‰ä¸€ä¸ª
- `page.js`å†…å®¹é¡µï¼Œæ¯ä¸ªç›®å½•ä¸‹å¯ä»¥æœ‰ä¸€ä¸ª
- `loading.js`é»˜è®¤åŠ è½½é¡µï¼Œæ¯ä¸ªç›®å½•ä¸‹å¯ä»¥æœ‰ä¸€ä¸ª
- `not-found.js`é»˜è®¤çš„404é¡µ
- `error.js`é»˜è®¤çš„æŠ¥é”™é¡µ
- `default.js`åœ¨å¹¶è¡Œè·¯ç”±ä¸­çš„é»˜è®¤slot
- `route.js`åç«¯æ¥å£
- `middleware.js`ä¸­é—´ä»¶ï¼Œæ‹¦æˆªå¤„ç†æ‰€æœ‰è¯·æ±‚çš„

ç›®å½•åï¼š
- `a`å‚ä¸è·¯ç”±`/a`
- `a/b`å‚ä¸è·¯ç”±`a/b`
- `_private`ä¸å‚ä¸è·¯ç”±
- `[slug]`ä¸`[...slug]`åŠ¨æ€è·¯ç”±
- `(test)`åˆ†ç»„ï¼Œä¸å‚ä¸è·¯ç”±
- `@slot`å¹¶è¡Œè·¯ç”±
- `(.)path` `(..)path` `(...)path`æ‹¦æˆªè·¯ç”±

# 3 æ¸²æŸ“
`next` `remix` ç­‰æ¡†æ¶éƒ½æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSR server side renderingï¼‰ï¼Œä¸ä¹‹å¯¹åº”çš„å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆCSR client side renderingï¼‰ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæˆ‘ä»¬ç®€å•ä»‹ç»ä¸‹ã€‚

æ­£å¸¸çš„`react`é¡¹ç›®æ˜¯CSRï¼Œä»–çš„äº¤äº’æµç¨‹æ˜¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚é¡µé¢ï¼ŒæœåŠ¡ç«¯è¿”å›çš„`html`å’Œ`js`ä»£ç ï¼Œå…¶ä¸­`html`ä»£ç ä¸­ï¼Œåªæœ‰ä¸€ä¸ª`<div id="root"></div>`ï¼Œç­‰`js`ä¸‹è½½å®Œæˆåï¼Œä¼šåœ¨å®¢æˆ·ç«¯åŠ¨æ€çš„æŠŠå„ç§`dom`è¿½åŠ åˆ°è¿™ä¸ªæ ¹`div`ä¸Šé¢å»ï¼Œå½¢æˆæœ€åçš„é¡µé¢ï¼Œè¿™å°±æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ã€‚

ä»¥å‰çš„`php`é¡¹ç›®éƒ½æ˜¯SSRï¼Œä»–çš„äº¤äº’æµç¨‹æ˜¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚é¡µé¢ï¼ŒæœåŠ¡ç«¯åŒæ ·è¿”å›`html`å’Œ`js`ä»£ç ï¼Œåªä¸è¿‡æœåŠ¡ç«¯åœ¨è¿”å›ä¹‹å‰ä¼šè¯†åˆ«å‡ºå…¶ä¸­æœåŠ¡ç«¯éœ€è¦è®¡ç®—çš„éƒ¨åˆ†ä¾‹å¦‚`<h1><?php echo $username ?></h1>`ï¼Œå°±ä¼šå°†`php`æ ‡ç­¾åœ¨æœåŠ¡ç«¯è¯†åˆ«å‡ºæ¥ï¼Œå¹¶ä¸”è¿è¡Œå…¶ä¸­çš„ä»£ç æŠŠæœ€ç»ˆçš„è¾“å‡ºå†…å®¹æ›¿æ¢åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„ä»£ç æ˜¯`<h1>Frank</h1>`è¿™æ ·çš„htmlä»£ç ï¼Œè¿™å°±æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ã€‚

æœåŠ¡ç«¯æ¸²æŸ“å¾ˆæ—©å°±æœ‰äº†ï¼Œä»–åœ¨æ€§èƒ½ã€ç½‘ç»œä¼ è¾“ç­‰æ–¹é¢éƒ½è¦å¥½è¿‡å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œä½†æ˜¯å› ä¸ºå‰ç«¯æ¡†æ¶çš„æ¼”è¿›ï¼Œè¢«å®¢æˆ·ç«¯æ¸²æŸ“æ›¿ä»£ã€‚è€Œ`next`ç­‰æ¡†æ¶åˆå›åˆ°äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œç®—æ˜¯ä¸€ç§â€œå€’é€€â€ï¼Œåªä¸è¿‡ç°åœ¨çš„æœåŠ¡ç«¯æ¸²æŸ“æ¯”å½“åˆçš„æ›´åŠ å¤æ‚ï¼Œå¯ä»¥ä½¿ç”¨åŒä¸€ç§è¯­è¨€jsã€åŒä¸€å¥—æ¡†æ¶reactã€å¹¶ä¸”æ•°æ®ä¼ è¾“å’Œç”¨æˆ·ä½“éªŒä¸Šæ›´åŠ æ— ç¼ã€‚

`next`ä¸­ä¸åŒçš„urlè·¯å¾„ï¼Œæœ‰ä¸‰ç§é‡è¦çš„æœåŠ¡ç«¯çš„æ¸²æŸ“æ¨¡å¼ï¼š
- é™æ€æ¸²æŸ“ï¼Œå¦‚æœå‘ç°è¯¥è·¯å¾„ä¸‹çš„é¡µé¢æ˜¯å®Œå…¨ä¸ä¼šæ”¹å˜çš„ï¼Œä¼šä¼˜å…ˆæŒ‰ç…§é™æ€æ¸²æŸ“ï¼Œç›´æ¥ç”Ÿæˆ`html`é¡µé¢ï¼Œåç»­ä¸ä¼šå˜äº†ã€‚
- åŠ¨æ€æ¸²æŸ“ï¼Œå¦‚æœæœ‰è¯»å–`cookie` `[slug]`ç­‰ï¼Œæ ¹æ®å‚æ•°æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œåˆ™æ— æ³•é¢„æ¸²æŸ“ï¼Œå°±ä¼šä½¿ç”¨åŠ¨æ€æ¸²æŸ“ï¼Œå³æ¯ä¸ªè¯·æ±‚æ¥äº†åœ¨æœåŠ¡ç«¯æ¸²æŸ“ã€‚
- æµæ¸²æŸ“ï¼Œæ‹†åˆ†åŒä¸€é¡µé¢å¤šä¸ªç»„ä»¶çš„åŠ è½½ï¼Œç”¨`Suspense`ç»„ä»¶wrapï¼Œè¾¾åˆ°å¹¶è¡Œè·¯ç”±ç›¸åŒæ•ˆæœï¼Œå…ˆåŠ è½½çš„å…ˆæ˜¾ç¤ºï¼Œæ˜¯ä¸€ç§æ›´ç²¾ç»†çš„æ¸²æŸ“æ§åˆ¶ã€‚
## 3.1 é™æ€æ¸²æŸ“(é¢„æ¸²æŸ“)
æˆ‘ä»¬æ–°å»ºä¸€ä¸ª`next app`ï¼Œç®€åŒ–ä¸€ä¸‹`src/app/page.js`ï¼Œå¦‚ä¸‹ï¼š
```js :page.js
export default function Home() {
  return <div>hello</div>;
}
```
é€šè¿‡`npm run build`çš„æ—¥å¿—ï¼Œèƒ½çœ‹åˆ°ä¸€å…±ä¿©é¡µé¢ï¼Œä¸€ä¸ªæ˜¯é¦–é¡µï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯é»˜è®¤çš„404é¡µé¢ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº›jsç­‰æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªé¡µé¢å‰é¢æ˜¯ä¸ªåœ†åœˆï¼Œä¸‹é¢æ³¨é‡Šè¯´è¿™æ˜¯é™æ€é¢„æ¸²æŸ“çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯ä¸‰ç§æ¸²æŸ“çš„ç¬¬ä¸€ç§ã€‚é»˜è®¤èƒ½å¤Ÿé¢„æ¸²æŸ“çš„ï¼Œéƒ½ä¼šç”¨è¿™ç§æ–¹å¼ã€‚

![image](https://i.imgur.com/mzMLRGM.png)

æˆ‘ä»¬åœ¨æ„å»ºå®Œæˆåï¼Œåˆ°`.next/server/app/index.html`ä¸­å¯ä»¥çœ‹åˆ°`/`å¯¹åº”çš„ä»£ç ï¼Œå®é™…è®¿é—®`/`çš„æ—¶å€™ï¼Œå°±æ˜¯ç›´æ¥è·å–çš„è¿™ä¸ª`html`æ–‡ä»¶ã€‚

![image](https://i.imgur.com/dozBdZn.png)

![image](https://i.imgur.com/nWZ4Myh.png)

ç›´æ¥è®¿é—®`localhost:3000`ä¹Ÿèƒ½çœ‹åˆ°ç›¸åŒçš„ä»£ç ï¼Œä»è¿™ä¸ªä»£ç ä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°æœ‰ä¸€äº›å¿…è¦çš„jsæ–‡ä»¶ï¼Œæ­¤å¤–ä¸‹æ–¹æœ‰`self.__next_f.push`å­—æ ·çš„ä»£ç ï¼Œå†…å®¹æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ ¼å¼ï¼ˆä»–ä¸index.rscå†…å®¹ä¸€è‡´ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®æ˜¯`next`è‡ªå·±ç»´æŠ¤çš„ï¼Œç”¨æ¥åŠ¨æ€çš„ä¿®æ”¹é¡µé¢çš„å†…å®¹çš„ï¼Œåªä¸è¿‡è¿™é‡Œæˆ‘ä»¬æ˜¯çº¯é™æ€çš„ï¼Œå†…å®¹ä¸ä»–å‡½æ•°ä¸­çš„å†…å®¹å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥çœ‹ä¸Šå»æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚

ä¾‹å¦‚æˆ‘ä»¬ä¿®æ”¹`index.html`æ¥æ¢ç©¶`self.__next_f.push`çš„ä½œç”¨ï¼Œè¿™é‡Œæˆ‘å°†`title` `viewport` `description`ç›´æ¥æ³¨é‡Šæ‰äº†ï¼Œç„¶å`npm run start`ã€‚

![image](https://i.imgur.com/mdEhKQl.png)

![image](https://i.imgur.com/0muBPC4.png)

è¿™å°±æ˜¯`next`æä¾›çš„åŠ¨æ€åŠ è½½çš„æœºåˆ¶ï¼Œåœ¨`html`çš„æœ€åé€šè¿‡è¿™ç§ç‰¹æ®Šçš„`payload`æ ¼å¼ï¼Œå¯ä»¥å¯¹å½“å‰çš„é¡µé¢è¿›è¡Œè°ƒæ•´ï¼Œå¯ä»¥è°ƒæ•´å±•ç¤ºçš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥åŠ¨æ€çš„å»åŠ è½½å…¶ä»–`css` `js`æ–‡ä»¶ï¼Œæä¾›æ›´å¤æ‚çš„åç»­é€»è¾‘ã€‚æˆ‘ä»¬ä¼šåœ¨åç»­çš„ä¸¤ç§æ¸²æŸ“ç§çœ‹åˆ°ã€‚

## 3.2 åŠ¨æ€æ¸²æŸ“(æœåŠ¡ç«¯å³æ—¶æ¸²æŸ“)
ä½¿ç”¨`[slug]`æˆ–ä½¿ç”¨`cookie`æ˜¯æœ€ç®€å•çš„é€ æˆé¡µé¢åªèƒ½åŠ¨æ€æ¸²æŸ“çš„æ–¹å¼ï¼ŒåŠ¨æ€çš„å‚æ•°æ˜¯æ— æ³•é¢„çŸ¥ä»–çš„å–å€¼çš„ã€‚
```js :page.js
import { cookies } from "next/headers";

export default function Home() {
  console.log(cookies().getAll());
  return <div>hello</div>;
}
```
é‡æ–°`build`ï¼Œæ­¤æ—¶`/`ä¸å†æ˜¯é™æ€æ¸²æŸ“ï¼Œè€Œæ˜¯åŠ¨æ€æ¸²æŸ“ï¼Œå¦‚ä¸‹ï¼š

![image](https://i.imgur.com/a5hCmGW.png)

æ­¤æ—¶è®¿é—®é¡µé¢ï¼Œå‘ç°é¡µé¢ä»£ç ä¸ä¹‹å‰å®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°`index.html`äº†ï¼Œè¿™å°±æ˜¯åŠ¨æ€æ¸²æŸ“ï¼Œæˆ–è€…å«å³æ—¶æ¸²æŸ“ï¼Œæ˜¯è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¸´æ—¶è®¡ç®—å‡ºæ¥çš„`html`ä»£ç å¹¶è¿”å›çš„ã€‚

![image](https://i.imgur.com/5DqAkcz.png)

æ¥ä¸‹æ¥ï¼šæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œç„¶åè®¾ç½®`loading.js`ã€‚
```js :page.js {4}
import { cookies } from "next/headers";

export default async function Home() {
  await new Promise(res=>setTimeout(res, 3000))
  console.log(cookies().getAll());
  return <div>hello</div>;
}

```
```js :loading.js
export default function Loading() {
    return <div>Loading...</div>
}
```
ç„¶åé‡æ–°`build`ï¼Œæ³¨æ„ä¸€å®šè¦ä¿ç•™ä¸Šé¢`cookies`ä»£ç ï¼Œä¸ç„¶å°±ä¼šç›´æ¥é™æ€æ¸²æŸ“äº†ã€‚æ­¤æ—¶æ‰“å¼€é¡µé¢ä¼šæ˜¾ç¤º`Loading...`ï¼Œ3såæ˜¾ç¤º`hello`ï¼Œæˆ‘ä»¬æŸ¥çœ‹é¡µé¢ä»£ç ï¼š

åœ¨é¡µé¢åˆšåŠ è½½3så†…çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç‚¹å¼€`html`çš„æºç å¦‚ä¸‹ï¼Œå‘ç°é¡µé¢ä¸­ç¡®å®æ˜¯æœ‰ä¸ª`loading`çš„divã€‚

![image](https://i.imgur.com/7YhyYV4.png)

3såhtmlçš„ä»£ç ä¼šè¢«è‡ªåŠ¨æ›´æ–°ï¼Œè¿™æ˜¯httpæä¾›çš„ä¸€ç§æµå¼åŠ è½½çš„æŠ€æœ¯ï¼Œåœ¨åé¢æµæ¸²æŸ“ä¸­ä¹Ÿæ˜¯ä½¿ç”¨äº†è¿™ä¸ªæŠ€æœ¯ï¼Œ

![image](https://i.imgur.com/GMDcRmt.png)

3såçš„`html`ä»£ç ä¸­ï¼Œä¼šå¤šå‡ºä¸€éƒ¨åˆ†ä»£ç ï¼Œæ–°è¿½åŠ äº†ä¸€ä¸ªéšè—çš„`div`ï¼Œidæ˜¯`S:1`ï¼Œå¹¶è¿½åŠ äº†ä¸€æ®µjsï¼ŒæŠŠ`P:1`ç”¨`S:1`ç»™æ›¿æ¢æ‰äº†ã€‚

æˆ‘ä»¬å¯èƒ½å¸Œæœ›é¡µé¢æ˜¯åŠ¨æ€æ¸²æŸ“çš„ï¼Œä½†æ˜¯è¢«è¯†åˆ«æˆäº†é™æ€æ¸²æŸ“ï¼Œä¾‹å¦‚ç›´æ¥`<div>{new Date()}</div>`å°±ä¼šè¢«è¯†åˆ«ä¸ºé™æ€æ¸²æŸ“ï¼Œå¯¼è‡´æ—¶é—´ä¸€ç›´å›ºå®šæ­»äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å¸Œæœ›è¯¥é¡µé¢æ˜¯åŠ¨æ€æ¸²æŸ“çš„ï¼Œå¯ä»¥åœ¨`page.js`ä¸­å¼ºåˆ¶æŒ‡å®š`dynamic`ï¼Œåœ¨ä¹‹å‰apiéƒ¨åˆ†æåˆ°è¿‡ã€‚
```diff :page.js
+ export const dynamic = 'force-dynamic'; //é»˜è®¤æ˜¯auto
```

## 3.3 æµæ¸²æŸ“
æµæ¸²æŸ“çš„åŸç†ä¸ä¸Šé¢ä»‹ç»çš„ç±»ä¼¼ï¼Œæµæ¸²æŸ“ä¸ºäº†è§£å†³ä¸€ä¸ªé¡µé¢è¦ä¹ˆæ˜¯é™æ€æ¸²æŸ“ï¼Œè¦ä¹ˆæ˜¯åŠ¨æ€æ¸²æŸ“çš„é—®é¢˜ï¼Œå½“ä¸€ä¸ªé¡µé¢æœ‰å¤šä¸ªç»„ä»¶ï¼Œä¾‹å¦‚`sider` `header`ç­‰ç»„ä»¶æ¸²æŸ“å¾ˆå¿«ï¼Œåªæœ‰`content`ç»„ä»¶æ¸²æŸ“è¾ƒæ…¢ï¼Œéœ€è¦è¯·æ±‚dbæ•°æ®ç­‰æƒ…å†µã€‚é‚£ä¹ˆå°±é€‚åˆæŠŠé¡µé¢æ‹†åˆ†ï¼Œé‡‡ç”¨æµæ¸²æŸ“ï¼Œå½“ç„¶å¦‚æœä»”ç»†çœ‹è¿™ç¯‡æ–‡æ¡£çš„è¯ï¼Œä¼šå‘ç°`å¹¶è¡Œè·¯ç”±`å…¶å®å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œåªä¸è¿‡`æµæ¸²æŸ“`æä¾›äº†æ›´å°ä»£ä»·çš„å†™æ³•ï¼Œä¸¤è€…æ•ˆæœä¸€è‡´ã€‚

ä¾‹å¦‚æˆ‘ä»¬æŠŠ`page.js`æ”¹ä¸ºç”±`Left`å’Œ`Right`ç»„æˆï¼Œå…¶ä¸­å·¦è¾¹æ˜¯éœ€è¦1såŠ è½½å®Œæˆï¼Œè€Œå³è¾¹æ˜¯3sï¼Œæ­¤æ—¶çš„æ•ˆæœæ˜¯å‰3sï¼Œé¡µé¢éƒ½æ˜¯`loading...`ï¼Œç„¶åä¸€ä¸‹å­å·¦å³éƒ½åŠ è½½å‡ºæ¥ã€‚

![image](https://i.imgur.com/feGMBgS.gif)

æ·»åŠ `Suspense`ç»„ä»¶åï¼Œæ•ˆæœå°±å˜æˆ`left`å…ˆåŠ è½½å®Œå°±ä¼šå…ˆå±•ç¤ºï¼Œç„¶åæ˜¯`Right`ã€‚
```js :page.js
import Left from "./left";
import Right from "./right";
import { Suspense } from "react";

export const dynamic = 'force-dynamic'; // å¼ºåˆ¶æŒ‡å®šåŠ¨æ€æ¸²æŸ“
export default async function Home() {
  return <div>
    <Suspense 
    fallback={<div>Left is loading</div>}>
      <Left/>
    </Suspense>
    <Suspense
    fallback={<div>Right is loading</div>}>
      <Right/>
    </Suspense>
  </div>;
}
```
![image](https://i.imgur.com/GsqItlu.gif)

å…¶åŸç†ä¸ä¹‹å‰ä»‹ç»çš„ä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨äº†httpçš„ä¸€è¾¹åŠ è½½ä¸€è¾¹å±•ç¤ºçš„ç‰¹æ€§ï¼Œæ ‡æ³¨ä¸ºæœªåŠ è½½å®Œæˆï¼Œå°±å¯ä»¥åç»­æŒç»­å‘`html`ä»£ç ä¸­æ³¨å…¥å†…å®¹ã€‚

![image](https://i.imgur.com/QkMbYeh.png)

åŠ è½½ä¸­ï¼Œä¸æ–­è¿½åŠ htmlå†…å®¹çš„è¿‡ç¨‹ä¸­ï¼Œhtmlçš„æ ‡ç­¾å…¶å®`body` `html`ç­‰æ ‡ç­¾éƒ½æ˜¯æœªå…³é—­çš„ï¼Œåªä¸è¿‡æµè§ˆå™¨èƒ½è‡ªåŠ¨çº é”™ï¼Œå¸®æˆ‘ä»¬å…³é—­ï¼Œè¿™é‡Œä¹Ÿæ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§ã€‚

![iamege](https://i.imgur.com/sZhcNeu.png)

## 3.4 æ¸²æŸ“å°ç»“
`next`æä¾›äº†ä¸‰ç§æ¸²æŸ“æ–¹å¼ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦å…³æ³¨å…·ä½“æ¯ä¸ªé¡µé¢ä½¿ç”¨çš„æ¸²æŸ“æ–¹å¼æ˜¯ä»€ä¹ˆï¼Œå› ä¸º`next`ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ‰¾åˆ°åˆé€‚çš„æ¸²æŸ“æ–¹å¼ï¼Œè¿˜å¯ä»¥ç”¨`export const dynamic = 'force-dynamic';`æ¥å¼ºåˆ¶æŒ‡å®šåŠ¨æ€æ¸²æŸ“ã€‚

ä¸€èˆ¬è¢«æ£€æµ‹åˆ°ä¸ä¼šæœ‰å˜åŒ–çš„å†…å®¹ï¼Œå°±ä¼šä½¿ç”¨é™æ€æ¸²æŸ“ï¼Œä½¿å…¶ç›´æ¥å˜æˆ`html`é™æ€æ–‡ä»¶ï¼Œè¿™æ˜¯é€Ÿåº¦æœ€å¿«çš„ï¼›å¦‚æœä½¿ç”¨äº†`cookie` `[slug]`ç­‰åŠ¨æ€å‚æ•°ï¼Œé‚£ä¹ˆå°±åªèƒ½ä½¿ç”¨åŠ¨æ€æ¸²æŸ“ï¼›è€ŒåŠ¨æ€æ¸²æŸ“ä¸­è¿˜æœ‰ä¸€ç§æ›´ç»†ç²’åº¦æ§åˆ¶ä¸åŒç»„ä»¶æ¸²æŸ“ç”Ÿå‘½å‘¨æœŸçš„æµæ¸²æŸ“ã€‚

# 4 æœåŠ¡ç«¯ç»„ä»¶ä¸å®¢æˆ·ç«¯ç»„ä»¶
`next`è™½ç„¶æ˜¯`SSR`ï¼Œä½†æ˜¯åˆå¼•å…¥äº†reactçš„æœåŠ¡ç«¯ç»„ä»¶(React Server Component/RSC/SC)å’Œå®¢æˆ·ç«¯ç»„ä»¶(RCC)çš„æ¦‚å¿µï¼Œè¿™é‡Œä¼šæœ‰ä¸€äº›è®©äººå›°æƒ‘ã€‚å¦‚ä»Šçš„`next`å·²ç»å˜æˆäº†`SSR` `CSR` `Static` `Dynamic` `SSG` `ISR` `RSC` `RCC`ç­‰è¯¸å¤šæŠ€æœ¯æ··åˆä¸€ä½“çš„å¤æ‚æŠ€æœ¯æ¡†æ¶äº†ã€‚
- `SSR`ä¸`CSR`: `next`åŸºæœ¬æ˜¯`SSR`æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä½†æ˜¯ä¸Šé¢`æµæ¸²æŸ“`çš„æ¨¡å¼ï¼Œä¹Ÿä¼šæ¨é€`js`åˆ°å®¢æˆ·ç«¯æ¸²æŸ“ã€‚
- `Static` `Dynamic` `SSG` `ISR`: éƒ½æ˜¯æŒ‡æœåŠ¡ç«¯æ¸²æŸ“çš„ä¸€äº›ç­–ç•¥ã€‚é¡µé¢æ²¡æœ‰æ•°æ®çº¯é™æ€çš„ï¼Œä¼šæå‰æ¸²æŸ“å‡º`html`è¿™æ˜¯`Static`ï¼Œé¡µé¢æœ‰æ•°æ®è·å–ï¼Œä½†æ˜¯æå‰`generateStaticParams`é…ç½®äº†ï¼Œè¿™å°±æ˜¯`SSG`æœ¬è´¨ä¹Ÿæ˜¯`Static`ä¸€ç§ï¼Œåªä¸è¿‡`next`ä¸­å°†ä¸¤ç§åŒºåˆ†å¼€äº†ï¼Œ`ISR`å¢é‡é™æ€ç”Ÿæˆä¸`SSG`è¾…åŠ©äº§ç”Ÿçš„ï¼Œå½“æå‰é…ç½®çš„è·¯å¾„æœ‰æ–°å¢æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨`ISR`å¢é‡çš„ç”Ÿæˆæ–°çš„é™æ€é¡µé¢ã€‚`Dynamic`åˆ™æ˜¯çº¯åŠ¨æ€æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä¸Šé¢çœ‹åˆ°è¿‡äº†ã€‚
- `RSC`ä¸`RCC`: é»˜è®¤éƒ½æ˜¯æœåŠ¡ç«¯ç»„ä»¶ï¼Œåªæœ‰`use client`çš„æ‰æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ï¼ŒæœåŠ¡ç«¯ç»„ä»¶è¿è¡Œç¯å¢ƒæ˜¯`Nodejs`ï¼Œå®¢æˆ·å•æ˜¯æµè§ˆå™¨ï¼ŒæœåŠ¡ç«¯ç»„ä»¶å¯ä»¥è®¿é—®`fs` `db`ç­‰ï¼Œå®¢æˆ·ç«¯åˆ™å¯ä»¥è®¿é—®`document` `window`ç­‰ï¼Œæ­¤å¤–å¯¹äºäº‹ä»¶ï¼ˆç‚¹å‡»äº‹ä»¶ç­‰ï¼‰çš„å¤„ç†åªèƒ½åœ¨`RCC`ä¸­å¤„ç†ã€‚

æ³¨æ„ï¼šå¹¶ä¸æ˜¯å®¢æˆ·ç«¯ç»„ä»¶å°±ä¸€å®šæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼ŒæœåŠ¡ç«¯ç»„ä»¶å°±ä¸€å®šæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåªæ˜¯è¿è¡Œçš„ç¯å¢ƒå’Œå¯è®¿é—®çš„apiä¸åŒã€‚`next`ä¸­åŸºæœ¬éƒ½æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œå®¢æˆ·ç«¯ç»„ä»¶ä¹Ÿæ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„ã€‚åªä¸è¿‡ä¸æœåŠ¡ç«¯ç»„ä»¶ä¸åŒçš„æ˜¯å‘é€çš„`js`çš„ä»£ç ä¼šä¸ä¸€æ ·ã€‚
## 4.1 æœåŠ¡ç«¯ç»„ä»¶
å‰é¢ä»‹ç»çš„éƒ½æ˜¯æœåŠ¡ç«¯ç»„ä»¶ï¼Œè¿è¡Œç¯å¢ƒæ˜¯`Nodejs`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›è¯¸å¦‚`DB`æŸ¥è¯¢ã€`api`æŸ¥è¯¢ç­‰åç«¯çš„å·¥ä½œæ”¾åœ¨è¿™é‡Œï¼Œé…åˆ`loading.js`æˆ–è€…`Suspense`å¯ä»¥å®ç°å¾ˆå¥½çš„åŠ è½½ä¸­ç”¨æˆ·äº¤äº’ï¼Œå®ç°ä¸`useQuery`ä¸€æ ·çš„æ•ˆæœï¼Œ`searchParams`å‚æ•°æ˜¯ä»urlä¸­è§£ææŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œä¼šä½¿å½“å‰ç»„ä»¶æ˜¯åŠ¨æ€æ¸²æŸ“ã€‚
```js :page.js
export default async function Home({ searchParams }) {
  const id = searchParams.id || 1;
  const json = await queryDataFromApi(id)
  return (
    <div>
      <p>id:{json.id}</p>
      <p>title:{json.title}</p>
      <p>completed:{"" + json.completed}</p>
    </div>
  );
}

async function queryDataFromApi(id) {
  const res = await fetch('https://jsonplaceholder.typicode.com/todos/'+id)
  const json = await res.json()
  return json
}
```
### 4.1.1 æœåŠ¡ç«¯ç»„ä»¶ç‰¹å®šåŠŸèƒ½
exportçš„ç‰¹å®šé…ç½®é¡¹ï¼š

1 `export const dynamic = 'auto'`æŒ‡å®šå½“å‰é¡µé¢å¼ºåˆ¶åŠ¨æ€æˆ–é™æ€æ¸²æŸ“åˆ™ä½¿ç”¨`force-dynamic | force-static`ã€‚ä¸Šé¢å·²ç»çœ‹åˆ°è¿‡äº†ã€‚

2 `export function generateMetadata()`ä¸`export const metadata`ä½œç”¨ä¸€æ ·ï¼Œæ˜¯å®šä¹‰å½“å‰é¡µé¢çš„`<meta>`éƒ¨åˆ†ã€‚ä¸Šé¢ä¹Ÿçœ‹åˆ°è¿‡äº†ã€‚

3 `export async function generateStaticParams()`å¯¹åŠ¨æ€é¡µé¢ä¹Ÿè¿›è¡Œé™æ€å‚æ•°ç¼“å­˜ï¼Œä¾‹å¦‚`/todo/:id`è·¯ç”±ä¸‹ï¼Œæˆ‘çŸ¥é“idç›®å‰çš„å–å€¼æ˜¯0-9ï¼Œé‚£ä¹ˆå¯ä»¥æå‰ç”Ÿæˆè¿™10ä¸ªé¡µé¢ï¼Œè¶…è¿‡9çš„ï¼Œè¿˜æŒ‰ç…§åŠ¨æ€çš„æ–¹å¼æ¸²æŸ“ã€‚æ­¤åŠŸèƒ½éå¸¸å¸¸ç”¨ï¼Œè¿™é‡Œå±•ç¤ºç”¨æ³•ï¼Œåˆ›å»º`todo/[id]/page.js`ç”¨äºå¤„ç†`/todo/:id`çš„é¡µé¢ã€‚
```js :todo/[id]/page.js
export default async function Home({ params }) {
    const { id } = params;
    const json = await queryDataFromApi(id)
    return (
        <div>
            <p>id:{json.id}</p>
            <p>title:{json.title}</p>
            <p>completed:{"" + json.completed}</p>
        </div>
    );
}
async function queryDataFromApi(id) {
    const res = await fetch('https://jsonplaceholder.typicode.com/todos/' + id)
    const json = await res.json()
    return json
}
export async function generateStaticParams() {
    const arr = []
    for (var i=0; i<10; i++){
        arr.push({id: "" + i});
    }
    return arr;
}
```
æ„å»ºçš„æ—¶å€™0-9çš„é¡µé¢å°±ä¼šé™æ€æ„å»ºï¼Œè¿™é‡Œæ˜¯`SSGï¼ˆStatic Site Generatorï¼‰`

![image](https://i.imgur.com/dq40lzU.png)

![image](https://i.imgur.com/Ia9U1vd.png)

è®¿é—®0-9çš„æ—¶å€™ï¼Œé€Ÿåº¦å¾ˆå¿«å› ä¸ºå·²ç»æ¸²æŸ“æˆhtmläº†ï¼Œè€Œè®¿é—®>9çš„é¡µé¢æ—¶å€™ä¼šæ…¢ï¼Œå› ä¸ºæ­¤æ—¶æ˜¯åŠ¨æ€æ¸²æŸ“ï¼Œå»å‘èµ·fetchè¯·æ±‚æ•°æ®äº†ã€‚

![image](https://i.imgur.com/GjbNiEN.gif)

4 `export const dynamicParams = true` ä¸Šé¢æåˆ°çš„æ²¡æœ‰é™æ€ç”Ÿæˆçš„é¡µé¢id>9çš„ï¼Œé»˜è®¤æ˜¯åŠ¨æ€æ¸²æŸ“ï¼Œå¦‚æœè¿™é‡Œé…ç½®ä¸º`false`ï¼Œåˆ™ç›´æ¥404ã€‚
```diff :todo/[id]/page.js
+ export const dynamicParams = false
```
![image](https://i.imgur.com/mlOF1rM.png)

5 `export const revalidate = false` åŒæ ·ä¸`generateStaticParams`æœ‰å…³ï¼Œæ˜¯é‡æ–°æ„å»ºçš„æ—¶é•¿`false | number`ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªæ•°å­—ä»£è¡¨ç§’æ•°ï¼Œå¤šå°‘ç§’åï¼Œæˆ‘ä»¬å°†å‰é¢ä»£ç `generateStaticParams`å»æ‰ï¼Œè§‚å¯Ÿé»˜è®¤è¡Œä¸ºã€‚
```diff :todo/[id]/page.js
+ export const dynamicParams = true //æ”¹å›é»˜è®¤å€¼æˆ–åˆ é™¤
- export async function generateStaticParams() {
-     const arr = []
-     for (var i=0; i<10; i++){
-         arr.push({id: "" + i});
-     }
-     return arr;
- }
```
![image](https://i.imgur.com/oVNEUG4.gif)

æˆ‘ä»¬å‘ç°é»˜è®¤ä¸ä¼šæœ‰`ISR`å¢é‡çš„é™æ€é¡µé¢`1.html`äº§ç”Ÿï¼Œä½†æ˜¯è®¿é—®è¿˜æ˜¯å˜å¿«äº†ï¼Œæ˜¯å› ä¸ºæœ‰`fetch-cache`ä¼šå¯¹`fetch`å‡½æ•°è¿›è¡Œäº†è¯·æ±‚çº§åˆ«çš„ç¼“å­˜ã€‚

```js :todo/[id]/page.js
+ export const revalidate = 10
```
![image](https://i.imgur.com/mAH5S5R.gif)

â†‘å½“å¢åŠ äº†`revalidate`ä¸º10sï¼Œå‘ç°å’ŒåŸæ¥ä¸€æ ·ï¼Œå¹¶æ²¡æœ‰å¢é‡äº§ç”Ÿæ–°çš„é¡µé¢ï¼Œå› ä¸ºé¡µé¢æ„å»ºçš„æ—¶å€™æ²¡æœ‰æ‰¾åˆ°`generateStaticParams`ï¼Œå› è€ŒæŒ‰ç…§`dynamic`æ„å»ºäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¾—åŠ å›æ¥å¦‚ä¸‹ï¼Œè¿”å›ä¸ªç©ºæ•°ç»„å³å¯ï¼Œåªæ˜¯ä¸ºäº†æ ‡è¯†è¯¥é¡µé¢ï¼Œä½¿å…¶`SSG`æ„å»ºã€‚
```js :todo/[id]/page.js
+ export const revalidate = 10
+ export async function generateStaticParams() {
+     return [];
+ }
```
![image](https://i.imgur.com/L1hNiOT.png)

å½“æˆ‘ä»¬è¯·æ±‚é¡µé¢çš„æ—¶å€™ï¼Œå°±å‘ç°æ˜¯æœ‰`ISRå¢é‡æ„å»ºé™æ€html`ï¼Œå¦‚ä¸‹ï¼Œå¹¶ä¸”è¯¥å¢é‡æ„å»ºé¡µé¢çš„æœ‰æ•ˆæœŸæ˜¯é…ç½®çš„10sï¼Œ10såè¯·æ±‚`todo/1`ä¼šé‡æ–°æ„å»ºè¿™ä¸ªé¡µé¢ã€‚

![image](https://i.imgur.com/SWKu9sB.gif)


å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å‡½æ•°ï¼š

1 `fetch()`å®Œå…¨å…¼å®¹WebAPIä¸­çš„`fetch`åŠŸèƒ½ï¼Œä¸éœ€è¦é¢å¤–`import node-fetch`ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”æœ‰ç¼“å­˜é…ç½®ï¼Œä¸Šé¢å…¶å®çœ‹åˆ°äº†`fetch-cache`ç›®å½•ã€‚ä¹Ÿå°±æ˜¯è¯¥å‡½æ•°é»˜è®¤çš„ç»“æœéƒ½ä¼šç¼“å­˜ã€‚
```js
fetch(`https://...`, { cache: 'force-cache' | 'no-store' })        
// æ˜¯å¦å¼€å¯ç¼“å­˜çš„é…ç½®ï¼Œé»˜è®¤æ˜¯force-cache

fetch(`https://...`, { next: { revalidate: false | 0 | number } }) 
// å¦‚æœå¼€å¯ç¼“å­˜ï¼Œè¿™ä¸ªé…ç½®æ˜¯å†³å®šæœ‰æ•ˆæœŸçš„ï¼Œé»˜è®¤falseæ˜¯æ— é™é•¿ç¼“å­˜
// 0æ˜¯å…³é—­ç¼“å­˜ï¼Œ1æ˜¯1sæœ‰æ•ˆæœŸ...
```
2 `cookies()`ä¸Šé¢å·²ç»çœ‹åˆ°äº†ï¼Œè¯¥å‡½æ•°èƒ½è·å–åˆ°`cookie`ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”ä¼šå¯¼è‡´ç»„ä»¶åŠ¨æ€æ¸²æŸ“ã€‚
```js
import { cookies } from 'next/headers'
...
  const cookieStore = cookies()
  const theme = cookieStore.get('theme')
```
3 `headers()`è¯·æ±‚å¤´
```js
import { headers } from 'next/headers'
...
  const headersList = headers()
  const referer = headersList.get('referer')
```
4 `notFound()`è·³è½¬åˆ°404é¡µé¢ï¼Œè¯¥å‡½æ•°æ˜¯æŠ›å‡ºä¸€ä¸ªç‰¹å®šçš„å¼‚å¸¸å®ç°çš„ï¼Œå› è€Œä¸éœ€è¦return
```js
import { notFound } from 'next/navigation'
......
  if (!user) {
    notFound() // æŠ›å‡ºå¼‚å¸¸å®ç°çš„ï¼Œä¸ç”¨ç®¡åé¢æ˜¯å¦æœ‰ä»£ç 
  }
```
5 `redirect(path, 'replace|push')`è·³è½¬ï¼Œä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªç‰¹å®šçš„å¼‚å¸¸æŠ›å‡ºå®ç°çš„ï¼Œ`replace`è¿™ä¸ªä¸€èˆ¬ä¸ç”¨æ”¹ã€‚
```js
import { redirect } from 'next/navigation'
...
  if (!user) {
    redirect('/login')
  }
```
## 4.2 å®¢æˆ·ç«¯ç»„ä»¶
å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¸»è¦ç”¨æ¥å¤„ç†ç”¨æˆ·äº¤äº’äº‹ä»¶å’Œé’©å­å‡½æ•°ï¼Œä»¥åŠè®¿é—®æµè§ˆå™¨ç›¸å…³çš„apiã€‚ä¾‹å¦‚åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­ä½¿ç”¨`onClick`ä¼šæŠ¥é”™
```js :page.js
export default function() {
    return <>
        <button onClick={()=>alert(123)}>click</button>
    </>
}
```
å°±ä¼šæŠ¥é”™
```
 â¨¯ Error: Event handlers cannot be passed to Client Component props.
  <button onClick={function onClick} children=...>
```
å› ä¸ºäº‹ä»¶å’Œé’©å­ï¼Œåªèƒ½åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨ï¼Œæ­£ç¡®çš„ä½¿ç”¨ç”¨æˆ·äº¤äº’äº‹ä»¶ä¸é’©å­å¦‚ä¸‹ï¼š
```js :page.js
'use client'

import { useState } from "react"

export default function Rsc() {
    const [count, setCount] = useState(0)
    return <>
        <button onClick={()=>{alert(count); setCount(count+1)}}>click</button>
    </>
}
```
ç›¸å¯¹åº”çš„å¦‚æœå£°æ˜ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ï¼Œå°±æ— æ³•ä½¿ç”¨æœåŠ¡ç«¯çš„apiå’ŒåŠŸèƒ½äº†ã€‚`build`ä¼šå‘ç°å®¢æˆ·ç«¯ç»„ä»¶æ˜¯`Static`é™æ€é¢„æ¸²æŸ“çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ç»„ä»¶åªæ˜¯è¯´jsä»£ç ä¼šåœ¨æµè§ˆå™¨è¿è¡Œï¼Œä½†æ˜¯æ¸²æŸ“è¿˜æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ã€‚

![image](https://i.imgur.com/pwdFWF8.png)

è¿™ä¸ªå§‹ç»ˆåœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„æ¨¡å¼ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœåœ¨æ¸²æŸ“çš„å‡½æ•°ä¸­ï¼Œä½¿ç”¨äº†`document`ç­‰å˜é‡ï¼Œå› ä¸ºæ¸²æŸ“æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ˜¯æ²¡æœ‰è¿™ä¸ªå˜é‡çš„ï¼Œæ­¤æ—¶å°±ä¼šæŠ¥é”™ã€‚é‚£è¯¥å¦‚ä½•æ­£ç¡®çš„ä½¿ç”¨å®¢æˆ·ç«¯ç»„ä»¶è°ƒç”¨æµè§ˆå™¨çš„apiå‘¢ï¼Ÿ

å°±æ˜¯é€šè¿‡`useEffect`ï¼Œè¿™ä¸€ç‚¹éå¸¸éå¸¸é‡è¦ï¼Œç”¨`useEffect`é’©å­ï¼Œç¡®ä¿ä¸€å®šæ˜¯åœ¨å®¢æˆ·ç«¯è¿è¡Œçš„æ•´æ®µä»£ç ï¼Œå› ä¸ºæ˜¯ä¸ªå›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥buildçš„æ—¶å€™æ‰§è¡Œä¸åˆ°é‡Œé¢çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¼šå‘é€åˆ°å®¢æˆ·ç«¯å»æ‰§è¡Œï¼Œé¿å¼€äº†æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œè®¿é—®`document`å˜é‡ã€‚
```js :page.js
'use client'

import {useEffect} from 'react'

export default function App() {
    useEffect(() => {
        const dom = document.getElementById("123")
        console.log(dom)
    })
    return <>
        <button id="123" onClick={()=>alert(111)}>click</button>
    </>
}
```
è€Œå¦‚æœæ˜¯å¼•å…¥çš„ç¬¬ä¸‰æ–¹åº“ï¼Œç›´æ¥åœ¨`import`çš„æ—¶å€™å°±éœ€è¦è®¿é—®`document`ç­‰ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨`useEffect`ä¸­åŠ¨æ€å¼•å…¥ï¼Œä¾‹å¦‚`asciinema-player`å°±æ˜¯è¿™æ ·çš„ç»„ä»¶ï¼Œä»–åœ¨nextä¸­æ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ã€‚
```jsx
'use client'
import React, { useEffect, useRef } from 'react';
import 'asciinema-player/dist/bundle/asciinema-player.css';

const AsciinemaPlayer = ({ src, options }) => {
  const playerRef = useRef(null);
  const hasInitialized = useRef(false);
  useEffect(() => {
    // åŠ¨æ€å¯¼å…¥ asciinema-player ä»¥ç¡®ä¿å®ƒåªåœ¨å®¢æˆ·ç«¯åŠ è½½
    import('asciinema-player').then((asciinemaPlayer) => {
      if (playerRef.current && !hasInitialized.current) {
        asciinemaPlayer.create(src, playerRef.current, options);
        hasInitialized.current = true;
      }
    });
  }, []);

  return <div ref={playerRef} ></div>;
};

export default AsciinemaPlayer;
```

å®¢æˆ·ç«¯ç»„ä»¶ï¼Œåªæœ‰ä¸‡ä¸å¾—å·²æ‰å»ä½¿ç”¨ï¼Œå¹¶ä¸”å°½é‡ä¿è¯éœ€è¦å®¢æˆ·ç«¯ç»„ä»¶çš„éƒ¨åˆ†ï¼Œå•ç‹¬æ‹†æˆç»„ä»¶ï¼Œå¤§éƒ¨åˆ†ä»ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå®¢æˆ·ç«¯åªåœ¨ç»„ä»¶æ ‘çš„æœ€ä½å±‚è¿›è¡Œä½¿ç”¨ã€‚

å› ä¸ºå®¢æˆ·ç«¯ç»„ä»¶æœ‰ä¼ æŸ“æ€§ï¼Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­`import`çš„ç»„ä»¶éƒ½ä¼šåœ¨è¿™é‡Œå˜æˆå®¢æˆ·ç«¯ç»„ä»¶ï¼Œè€ŒæœåŠ¡ç«¯ç»„ä»¶æ²¡æœ‰ä¼ æŸ“æ€§ï¼Œå¯ä»¥å¼•å…¥å®¢æˆ·ç«¯ç»„ä»¶ï¼Œäº•æ°´ä¸çŠ¯æ²³æ°´ã€‚

### 4.2.1 å®¢æˆ·ç«¯ç»„ä»¶ç‰¹å®šåŠŸèƒ½
é™¤äº†äº‹ä»¶å’Œreacté’©å­ï¼Œnextæä¾›äº†ç‰¹å®šçš„é’©å­ï¼š

1 `useParams()`ä¸æœåŠ¡ç«¯ç»„ä»¶çš„å…¥å‚`{params}`åŠŸèƒ½ä¸€è‡´
```js
'use client'
 
import { useParams } from 'next/navigation'
 
export default function ExampleClientComponent() {
  const params = useParams()
  console.log(params)
  return <></>
}
```

2 `usePathname()`è·å–å½“å‰è·¯å¾„ï¼ŒæœåŠ¡ç«¯ç»„ä»¶ä¸­æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½
```js
'use client'
 
import { usePathname } from 'next/navigation'
 
export default function ExampleClientComponent() {
  const pathname = usePathname()
  return <p>Current pathname: {pathname}</p>
}
```

![img](https://i.imgur.com/atyNKUx.png)

3 `useRouter()`è·³è½¬ï¼Œå®˜æ–¹å»ºè®®ä¸è¦ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨`<Link>`
```js
'use client'
 
import { useRouter } from 'next/navigation'
 
export default function Page() {
  const router = useRouter()
 
  return (
    <button type="button" onClick={() => router.push('/dashboard')}>
      Dashboard
    </button>
  )
}
```

4 `useSearchParams`ä¸æœåŠ¡ç«¯ç»„ä»¶å‚æ•°ä¸­`{searchParams}`åŠŸèƒ½ä¸€è‡´ï¼Œè§£ææŸ¥è¯¢å­—ç¬¦ä¸²ã€‚
```js
'use client'
 
import { useSearchParams } from 'next/navigation'
 
export default function SearchBar() {
  const searchParams = useSearchParams()
 
  const search = searchParams.get('search')
 
  // URL -> `/dashboard?search=my-project`
  // `search` -> 'my-project'
  return <>Search: {search}</>
}
```
## 4.3 äº¤å‰ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹
å‰é¢æåˆ°äº†å®¢æˆ·ç«¯ç»„ä»¶çš„ä¼ æŸ“æ€§ï¼Œæ‰€ä»¥æœ€å¥½åœ¨ç»„ä»¶æ ‘`low level`å»ä½¿ç”¨å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¾‹å¦‚å¦‚æœåœ¨`app/layout.js`ä¸­ä½¿ç”¨`use client`æŒ‡ä»¤ï¼Œå°±ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼Œä¼šå¯¼è‡´æ‰€æœ‰ç»„ä»¶éƒ½ä¼šå˜æˆå®¢æˆ·ç«¯ç»„ä»¶ï¼Œæ‰€æœ‰æœåŠ¡ç«¯åŠŸèƒ½éƒ½æ— æ³•ä½¿ç”¨äº†ã€‚

ä½†æ˜¯æœ‰æ—¶å€™å®¢æˆ·ç«¯ç»„ä»¶çš„åŠŸèƒ½å°±æ˜¯æ¯”è¾ƒé ä¸Šæ‰è¡Œï¼Œä¾‹å¦‚`reactçš„Context`ç»„ä»¶ï¼Œéœ€è¦ç”¨`useContext`ï¼Œå³åªèƒ½ç”¨å®¢æˆ·ç«¯ç»„ä»¶ï¼Œè€Œ`Context`åˆæ˜¯ä¸€ä¸ªæ¯”è¾ƒé ä¸Šçš„åŠŸèƒ½ï¼Œè¿™ç§æ—¶å€™å°±éœ€è¦ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æŠ€å·§ï¼Œæ¥èº²è¿‡â€œå®¢æˆ·ç«¯ç»„ä»¶importçš„ç»„ä»¶éƒ½ä¼šå˜æˆå®¢æˆ·ç«¯ç»„ä»¶â€è¿™æ¡è§„å¾‹ã€‚é‚£å°±æ˜¯ä½¿ç”¨`props`ä½œä¸ºå±æ€§ä¼ å…¥ï¼Œä¾‹å¦‚æœ€å¸¸ç”¨çš„å°±æ˜¯ä½œä¸º`children`ä¼ å…¥ï¼Œå°±ä¸ä¼šæœ‰`import`å¼•å…¥äº†ã€‚

ä½¿ç”¨`props`ä¾‹å¦‚`children`ï¼Œè¿™æ ·å°±èƒ½å®ç°ï¼šæœåŠ¡ç«¯ç»„ä»¶å†…å¼•å®¢æˆ·ç«¯ç»„ä»¶ï¼Œå®¢æˆ·ç«¯ç»„ä»¶å†ç”¨`children`åµŒå¥—æœåŠ¡ç«¯ç»„ä»¶ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š
```js
<ServerComponent1>
    <ClientComponent1>
        <ServerComponent2><ServerComponent2>
    </ClientComponent1>
</ServerComponent1>
```
å¸¸è§çš„ä¾‹å¦‚`XXProvider` `XXContext`éƒ½å¯ä»¥å€Ÿé‰´è¿™ä¸ªç”¨æ³•ï¼Œæˆ‘ä»¬ä»¥`react`çš„`Context`ä¸ºä¾‹ï¼Œé¦–å…ˆå®‰è£…ä¸€ä¸ª`js-cookie`çš„åº“ï¼Œæ–¹ä¾¿åœ¨æµè§ˆå™¨ç«¯è¯»å†™`cookie`
```bash
npm i js-cookie
```
```js :page.js
import Context from "./context"
import ServerComponent from './server'
import ClientComponent from './client'


// è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæœåŠ¡ç«¯å®¢æˆ·ç«¯ç»„ä»¶äº¤é”™ä½¿ç”¨ï¼š
// å½“å‰é¡µé¢Appæ˜¯æœåŠ¡ç«¯ç»„ä»¶
// Contextæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ç»„ä»¶ï¼Œä½¿ç”¨äº†reactContext
// ServerComponentæ˜¯ä¸€ä¸ªæœåŠ¡ç«¯ç»„ä»¶
// ClientComponentæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ç»„ä»¶
export default function App() {
   return <>
    <Context>
        <ServerComponent></ServerComponent>
        <hr />
        <ClientComponent></ClientComponent>
    </Context>
   </>
}
```
```js :context.js
'use client'

import Cookies from "js-cookie";
import { createContext, useEffect, useState } from "react"

export const ThemeContext = createContext('light');
export default function Context({children}) {
    const [theme, setTheme] = useState("light");

    useEffect(()=>{
        Cookies.set('theme', theme);
    }, [theme])

    const switchTheme = () => setTheme(
        theme == 'light' ? 'dark' : 'light')

    return <ThemeContext.Provider value={theme}>
        <button onClick={switchTheme}>åˆ‡æ¢</button>
        <div>
            Contextç»„ä»¶ å®¢æˆ·ç«¯ç»„ä»¶ theme={theme}
        </div>
        <hr/>
        {children}
    </ThemeContext.Provider>    
}
```
```js :server.js
import { cookies } from "next/headers";

export default function ServerComponent() {
    const cs = cookies()
    const theme = cs?.get('theme')?.value;
    return <div>ServerComponent theme from cookie theme={theme}</div>
}
```

```js :client.js
'use client'

import { useContext } from "react";
import { ThemeContext } from "./context";

export default function Client() {
    const theme  = useContext(ThemeContext)
    return <>
        å®¢æˆ·ç«¯ç»„ä»¶ï¼šç‚¹å‡»å±•ç¤ºå½“å‰çš„Context
        <div>
            <button onClick={()=>alert(theme)}>å±•ç¤º</button>
        </div>
    </>
}
```
æ¥ä¸‹æ¥æ‰“å¼€ä¸»é¡µï¼Œåˆ†åˆ«å±•ç¤ºäº†ä¸‰ä¸ªç»„ä»¶ Client-Server-Clientäº¤é”™ï¼Œå®¢æˆ·ç«¯ç»„ä»¶å› ä¸º`theme`èµ‹å€¼äº†åˆå€¼lightï¼Œç›´æ¥å±•ç¤ºå‡ºæ¥äº†ï¼›è€ŒæœåŠ¡ç«¯ç»„ä»¶æ˜¯è¯·æ±‚çš„æ—¶å€™è¯»å–çš„`cookie`ï¼Œå‰é¢ç»„ä»¶æ˜¯åœ¨`useEffect`èµ‹å€¼çš„`cookie`ï¼Œå› è€Œè¯·æ±‚ç›´æ¥æ¥çš„æ—¶å€™`cookie`æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ²¡æœ‰å€¼ï¼›cookieåœ¨é¡µé¢åŠ è½½å®Œä¹‹åï¼Œtheme=lightã€‚

![image](https://i.imgur.com/gCpjL9Z.png)

æ­¤æ—¶ç‚¹å‡»å±•ç¤ºæŒ‰é’®ï¼Œæ˜¾ç¤º`light`ï¼Œç›´æ¥ä»`context`ä¸­è¯»å–çš„å†…å®¹ï¼Œè™½ç„¶ä¸­é—´äº¤é”™éš”äº†ä¸ª`ServerComponent`ä½†æ˜¯ä»ç„¶èƒ½è·å–åˆ°ã€‚

![image](https://i.imgur.com/f65T09m.png)

ç„¶åç‚¹å‡»åˆ‡æ¢æŒ‰é’®ï¼Œç„¶åå†ç‚¹å‡»å±•ç¤ºï¼Œ`theme`ä¸Šä¸‹æ–‡çš„å€¼ï¼Œä¼šè¢«ä¿®æ”¹ï¼Œå¹¶ä¸”ä¼šè§¦å‘`ClientComponent`ç»„ä»¶çš„æ¸²æŸ“ï¼Œç‚¹å‡»æ˜¾ç¤ºçš„å€¼æ˜¯æ›´æ–°åçš„`dark`

![image](https://i.imgur.com/KOSiKTY.png)

æ­¤æ—¶åˆ·æ–°é¡µé¢ï¼Œ`cookie`çš„å€¼ä¼šä¼ åˆ°æœåŠ¡ç«¯ï¼Œæ­¤æ—¶æ˜¯`dark`æ‰€ä»¥æœåŠ¡ç«¯ç»„ä»¶æ˜¾ç¤º`dark`ã€‚ä½†æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ï¼Œå› ä¸ºé‡æ–°åˆ·æ–°ï¼Œè¢«è®¾ç½®äº†åˆå€¼`light`å±•ç¤º`light`ã€‚

![img](https://i.imgur.com/n91zZWb.png)